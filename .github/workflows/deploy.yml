name: ğŸš€ è‡ªåŠ¨éƒ¨ç½²åˆ° lss.work.gd

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ”§ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        npm install -g http-server
        # å¦‚æœæœ‰ package.jsonï¼Œå®‰è£…é¡¹ç›®ä¾èµ–
        if [ -f "package.json" ]; then
          npm install
        fi

    - name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
      run: |
        echo "ğŸ§¹ æ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§..."
        ls -la
        
        # æ£€æŸ¥å…³é”®æ–‡ä»¶
        if [ ! -f "index.html" ]; then
          echo "âŒ ç¼ºå°‘ index.html"
          exit 1
        fi
        
        if [ ! -f "style.css" ]; then
          echo "âŒ ç¼ºå°‘ style.css"
          exit 1
        fi
        
        if [ ! -f "script.js" ]; then
          echo "âŒ ç¼ºå°‘ script.js"
          exit 1
        fi
        
        echo "âœ… æ‰€æœ‰å…³é”®æ–‡ä»¶æ£€æŸ¥é€šè¿‡"

    - name: ğŸ”¨ æ„å»ºé¡¹ç›®
      run: |
        echo "ğŸ”¨ å¼€å§‹æ„å»ºé¡¹ç›®..."
        mkdir -p dist
        
        # å¤åˆ¶ä¸»è¦æ–‡ä»¶
        cp index.html dist/
        cp style.css dist/
        cp script.js dist/
        cp README.md dist/
        
        # å¤åˆ¶èµ„æºç›®å½•
        if [ -d "image" ]; then
          cp -r image dist/
        fi
        
        if [ -d "music" ]; then
          cp -r music dist/
        fi
        
        echo "âœ… é¡¹ç›®æ„å»ºå®Œæˆ"

    - name: âš¡ ä¼˜åŒ–æ–‡ä»¶
      run: |
        echo "âš¡ å¼€å§‹ä¼˜åŒ–æ–‡ä»¶..."
        
        # å‹ç¼©CSSï¼ˆç§»é™¤æ³¨é‡Šå’Œå¤šä½™ç©ºç™½ï¼‰
        if [ -f "dist/style.css" ]; then
          sed -i 's/\/\*.*\*\///g' dist/style.css
          sed -i 's/  */ /g' dist/style.css
          echo "âœ“ CSSæ–‡ä»¶å·²ä¼˜åŒ–"
        fi
        
        # å‹ç¼©HTMLï¼ˆç§»é™¤æ³¨é‡Šï¼‰
        if [ -f "dist/index.html" ]; then
          sed -i 's/<!--.*-->//g' dist/index.html
          echo "âœ“ HTMLæ–‡ä»¶å·²ä¼˜åŒ–"
        fi
        
        echo "âœ… æ–‡ä»¶ä¼˜åŒ–å®Œæˆ"

    - name: ğŸ“Š ç”Ÿæˆéƒ¨ç½²ä¿¡æ¯
      run: |
        echo "ğŸ“Š ç”Ÿæˆéƒ¨ç½²ä¿¡æ¯..."
        
        # åˆ›å»ºéƒ¨ç½²é…ç½®
        cat > dist/deploy.json << EOF
        {
          "name": "Aether Echoes Blog",
          "version": "$(date +%Y%m%d%H%M%S)-$(git rev-parse --short HEAD)",
          "buildTime": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "targetUrl": "https://www.lss.work.gd/",
          "commitHash": "$(git rev-parse HEAD)",
          "commitMessage": "$(git log -1 --pretty=%B)",
          "branch": "${{ github.ref_name }}",
          "buildNumber": "${{ github.run_number }}"
        }
        EOF
        
        echo "âœ… éƒ¨ç½²ä¿¡æ¯å·²ç”Ÿæˆ"

    - name: ğŸ§ª æµ‹è¯•æ„å»ºç»“æœ
      run: |
        echo "ğŸ§ª æµ‹è¯•æ„å»ºç»“æœ..."
        
        # å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨æµ‹è¯•
        cd dist
        http-server -p 8080 --silent &
        SERVER_PID=$!
        
        # ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨
        sleep 3
        
        # æµ‹è¯•ä¸»é¡µæ˜¯å¦å¯è®¿é—®
        if curl -f http://localhost:8080/ > /dev/null 2>&1; then
          echo "âœ… ç½‘ç«™æµ‹è¯•é€šè¿‡"
        else
          echo "âŒ ç½‘ç«™æµ‹è¯•å¤±è´¥"
          exit 1
        fi
        
        # åœæ­¢æµ‹è¯•æœåŠ¡å™¨
        kill $SERVER_PID

    - name: ğŸ“¤ æ¨é€åˆ° GitHub Pages (å¯é€‰)
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist
        publish_branch: gh-pages

    - name: ğŸŒ éƒ¨ç½²åˆ°ç›®æ ‡ç½‘ç«™
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      env:
        TARGET_URL: https://www.lss.work.gd/
      run: |
        echo "ğŸŒ å‡†å¤‡éƒ¨ç½²åˆ°ç›®æ ‡ç½‘ç«™..."
        
        # åˆ›å»ºéƒ¨ç½²è„šæœ¬
        cat > deploy_to_target.sh << 'EOF'
        #!/bin/bash
        echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° https://www.lss.work.gd/"
        
        # è¿™é‡Œéœ€è¦æ ¹æ®ç›®æ ‡ç½‘ç«™çš„å…·ä½“éƒ¨ç½²æ–¹å¼æ¥å®ç°
        # å¸¸è§çš„éƒ¨ç½²æ–¹å¼åŒ…æ‹¬ï¼š
        
        # æ–¹å¼1: FTPä¸Šä¼ 
        # if command -v lftp &> /dev/null; then
        #   lftp -c "
        #     set ftp:ssl-allow no;
        #     open -u $FTP_USER,$FTP_PASS $FTP_HOST;
        #     mirror -R dist/ /public_html/;
        #     quit
        #   "
        # fi
        
        # æ–¹å¼2: SSHéƒ¨ç½²
        # if [ ! -z "$SSH_PRIVATE_KEY" ]; then
        #   echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
        #   chmod 600 ~/.ssh/id_rsa
        #   rsync -avz --delete dist/ user@server:/var/www/html/
        # fi
        
        # æ–¹å¼3: APIè°ƒç”¨
        # if [ ! -z "$DEPLOY_API_KEY" ]; then
        #   curl -X POST "$DEPLOY_API_URL" \
        #     -H "Authorization: Bearer $DEPLOY_API_KEY" \
        #     -F "files=@dist.tar.gz"
        # fi
        
        # æ–¹å¼4: Webhookè§¦å‘
        if [ ! -z "$WEBHOOK_URL" ]; then
          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "action": "deploy",
              "repository": "${{ github.repository }}",
              "branch": "${{ github.ref_name }}",
              "commit": "${{ github.sha }}",
              "message": "Auto deploy from GitHub Actions"
            }'
        fi
        
        echo "âœ… éƒ¨ç½²å®Œæˆï¼"
        echo "ğŸŒ ç½‘ç«™åœ°å€: https://www.lss.work.gd/"
        EOF
        
        chmod +x deploy_to_target.sh
        ./deploy_to_target.sh

    - name: ğŸ“‹ éƒ¨ç½²æ€»ç»“
      if: always()
      run: |
        echo "
        ===================================
        ğŸ‰ éƒ¨ç½²æµç¨‹å®Œæˆ
        ===================================
        ğŸ“Š é¡¹ç›®: Aether Echoes Blog
        ğŸŒ ç›®æ ‡: https://www.lss.work.gd/
        ğŸ“ åˆ†æ”¯: ${{ github.ref_name }}
        ğŸ”¢ æ„å»º: #${{ github.run_number }}
        â° æ—¶é—´: $(date)
        ===================================
        "
        
        # å¦‚æœéƒ¨ç½²æˆåŠŸï¼Œè¾“å‡ºè®¿é—®é“¾æ¥
        if [ $? -eq 0 ]; then
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸ‘€ è®¿é—® https://www.lss.work.gd/ æŸ¥çœ‹ç½‘ç«™"
        else
          echo "âŒ éƒ¨ç½²è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯"
        fi

    - name: ğŸ’¬ éƒ¨ç½²é€šçŸ¥ (å¯é€‰)
      if: always()
      run: |
        # è¿™é‡Œå¯ä»¥æ·»åŠ é€šçŸ¥é€»è¾‘ï¼Œæ¯”å¦‚å‘é€é‚®ä»¶ã€Slackæ¶ˆæ¯ç­‰
        echo "ğŸ“¢ éƒ¨ç½²é€šçŸ¥å·²å‘é€"