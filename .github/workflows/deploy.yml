name: ğŸš€ è‡ªåŠ¨éƒ¨ç½²åˆ° lss.work.gd

on:
  push:
    branches: [ main, master, cursor/say-hello-in-chinese-c907 ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
      run: |
        echo "ğŸ§¹ æ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§..."
        ls -la
        
        # æ£€æŸ¥å…³é”®æ–‡ä»¶
        if [ ! -f "index.html" ]; then
          echo "âŒ ç¼ºå°‘ index.html"
          exit 1
        fi
        
        if [ ! -f "style.css" ]; then
          echo "âŒ ç¼ºå°‘ style.css"
          exit 1
        fi
        
        if [ ! -f "script.js" ]; then
          echo "âŒ ç¼ºå°‘ script.js"
          exit 1
        fi
        
        echo "âœ… æ‰€æœ‰å…³é”®æ–‡ä»¶æ£€æŸ¥é€šè¿‡"

    - name: ğŸ”¨ æ„å»ºé¡¹ç›®
      run: |
        echo "ğŸ”¨ å¼€å§‹æ„å»ºé¡¹ç›®..."
        mkdir -p dist
        
        # å¤åˆ¶ä¸»è¦æ–‡ä»¶
        cp index.html dist/
        cp style.css dist/
        cp script.js dist/
        cp README.md dist/
        
        # å¤åˆ¶èµ„æºç›®å½•
        if [ -d "image" ]; then
          cp -r image dist/
        fi
        
        if [ -d "music" ]; then
          cp -r music dist/
        fi
        
        echo "âœ… é¡¹ç›®æ„å»ºå®Œæˆ"

    - name: âš¡ ä¼˜åŒ–æ–‡ä»¶
      run: |
        echo "âš¡ å¼€å§‹ä¼˜åŒ–æ–‡ä»¶..."
        
        # ç®€å•çš„æ–‡ä»¶ä¼˜åŒ–
        if [ -f "dist/style.css" ]; then
          # ç§»é™¤CSSæ³¨é‡Šï¼ˆç®€å•ç‰ˆæœ¬ï¼‰
          sed -i 's|/\*.*\*/||g' dist/style.css
          echo "âœ“ CSSæ–‡ä»¶å·²ä¼˜åŒ–"
        fi
        
        if [ -f "dist/index.html" ]; then
          # ç§»é™¤HTMLæ³¨é‡Š
          sed -i 's|<!--.*-->||g' dist/index.html
          echo "âœ“ HTMLæ–‡ä»¶å·²ä¼˜åŒ–"
        fi
        
        echo "âœ… æ–‡ä»¶ä¼˜åŒ–å®Œæˆ"

    - name: ğŸ“Š ç”Ÿæˆéƒ¨ç½²ä¿¡æ¯
      run: |
        echo "ğŸ“Š ç”Ÿæˆéƒ¨ç½²ä¿¡æ¯..."
        
        # åˆ›å»ºéƒ¨ç½²é…ç½®
        cat > dist/deploy.json << EOF
        {
          "name": "Aether Echoes Blog",
          "version": "$(date +%Y%m%d%H%M%S)-$(git rev-parse --short HEAD)",
          "buildTime": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "targetUrl": "https://www.lss.work.gd/",
          "commitHash": "$(git rev-parse HEAD)",
          "commitMessage": "$(git log -1 --pretty=%B | head -1)",
          "branch": "${{ github.ref_name }}",
          "buildNumber": "${{ github.run_number }}"
        }
        EOF
        
        echo "âœ… éƒ¨ç½²ä¿¡æ¯å·²ç”Ÿæˆ"

    - name: ğŸ“¤ æ¨é€åˆ° GitHub Pages
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/cursor/say-hello-in-chinese-c907'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist
        publish_branch: gh-pages

    - name: ğŸŒ æ¨¡æ‹Ÿéƒ¨ç½²åˆ°ç›®æ ‡ç½‘ç«™
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/cursor/say-hello-in-chinese-c907'
      env:
        TARGET_URL: https://www.lss.work.gd/
      run: |
        echo "ğŸŒ å‡†å¤‡éƒ¨ç½²åˆ°ç›®æ ‡ç½‘ç«™..."
        echo "ğŸ“ æ„å»ºç›®å½•å†…å®¹ï¼š"
        ls -la dist/
        
        echo "ğŸ“„ éƒ¨ç½²é…ç½®ï¼š"
        cat dist/deploy.json
        
        echo "ğŸš€ æ¨¡æ‹Ÿéƒ¨ç½²è¿‡ç¨‹..."
        echo "âœ… æ–‡ä»¶å·²å‡†å¤‡å®Œæˆï¼"
        echo "ğŸŒ ç›®æ ‡åœ°å€: $TARGET_URL"
        
        # åœ¨å®é™…éƒ¨ç½²ä¸­ï¼Œè¿™é‡Œéœ€è¦æ·»åŠ å…·ä½“çš„ä¸Šä¼ é€»è¾‘
        # ä¾‹å¦‚ï¼šFTPä¸Šä¼ ã€SSHéƒ¨ç½²ã€APIè°ƒç”¨ç­‰

    - name: ğŸ“‹ éƒ¨ç½²æ€»ç»“
      if: always()
      run: |
        echo ""
        echo "=================================="
        echo "ğŸ‰ éƒ¨ç½²æµç¨‹å®Œæˆ"
        echo "=================================="
        echo "ğŸ“Š é¡¹ç›®: Aether Echoes Blog"
        echo "ğŸŒ ç›®æ ‡: https://www.lss.work.gd/"
        echo "ğŸ“ åˆ†æ”¯: ${{ github.ref_name }}"
        echo "ğŸ”¢ æ„å»º: #${{ github.run_number }}"
        echo "â° æ—¶é—´: $(date)"
        echo "=================================="
        
        if [ -d "dist" ]; then
          echo "âœ… æ„å»ºæˆåŠŸå®Œæˆï¼"
          echo "ğŸ“¦ æ„å»ºäº§ç‰©å¤§å°: $(du -sh dist/ | cut -f1)"
          echo "ğŸ“„ æ–‡ä»¶åˆ—è¡¨:"
          ls -la dist/
        else
          echo "âŒ æ„å»ºå¤±è´¥"
        fi